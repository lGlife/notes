2020 年 （河南-北京-广州 电子凭证，一体化项目压力测试）

## 性能分析流程

### 链路分析

根据链路跟踪功能，查询对应的接口的链路情况；分析具体到那一个方法中，比如：耗时在sql或者post某一个请求中。

但是非常有可能不能精准定位到某一个方法中，只能大致知晓耗时的父方法中；那么我们就需要分析这个方法里面是不是有循环处理。

### jvm分析

在压力测试的情况下面，我们抓取堆栈信息，根据堆栈信息分析CPU使用率最多信息，看看耗时在哪个业务的方法上面。

### 服务器资源情况

性能压力测试我们重点关注的是cpu的使用情况，我认为压力测试比较合理的cpu使用率应该要到达70%~80%左右，如果超过这个值或者达到这个值得，同时压力测试结果不符合预期，我们就需要抓堆栈进行分析，看看耗时在哪里；如果代码已经没有优化空间，那么我们就只能增加服务器资源。

### 代码分析

结合上面我们可以大致定位到代码的位置，大致的方法块中可能里面还有非常多的处理；那么我们就要结合代码在分析，看里面是否存在大循环的处理逻辑，如果不存在全部为单个处理，那就比较好分析，一般就是sql或者post请求；如果存在大循环处理，然后链接又没有严重的单个监控，那么肯定就是大循环导致每次毫秒级别的耗时，量化成质了，比如：每次3毫秒，循环100次就是300毫秒了。

## 性能处理方式

### 应用程序处理

1、日志通过配置可以输出为控制台模式，直接文件模式；经过测试直接文件模式，消耗的整体性能200ms左右，几乎没有影响，但是输出了控制台模式，消耗的时间差距在秒级，影响比较大。

2、分析过程发现大循环中，查询redis的处理，网络开销会由次数变大；我们增加二级缓存

3、分析过程中有大循环中，insert语句真实处理监控都是0ms，但是真实消耗时间非常大，那么既有可能是sql参数渲染（**Parameter**）消耗时间，（雷总那边修改了一下参数渲染的处理）

### 服务器处理

1、大量压力测试会出现nginx502， connect() failed (111: Connection refused) while connecting to upstream 错误；nginx需要调用，增加upstream  keepalive参数、location proxy_http_version 1.1; proxy_set_header Connection "";参数

注意：还可以增加nginx的缓存相关参数

2、sock *read* *time* out 错误，这个分为发压机的端口，nginx，应用的端口是否都正常，是否有大量的 *TIME*_*WAIT*的端口存在，调整服务器的sock相关参数，nginx 的参数 worker_connections  worker_processes参数 、最大打开文件数量 vi /etc/security/limits.conf、liunx内核参数 vi /etc/sysctl.conf 这个文件

3、如果还出现502 的错误，那么就把你的nginx的配置文件内的localhost改成127.0.0.1，可能是与IP4、IP6的解析之类的有关





