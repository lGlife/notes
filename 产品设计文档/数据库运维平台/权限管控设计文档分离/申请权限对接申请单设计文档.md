[toc]

### 申请权限对接申请单设计文档

#### 需求设计

数据库运维平台使用黑名单和白名单相结合的方式进行权限控制，普通用户在执行SQL语句时可能遇到无权限操作情况，因此普通用户需要申请权限。权限具有类别，普通用户可以申请具体类别的权限。

管理员可以查看普通用户申请权限汇总界面，用于查看普通用户已通过审核的申请权限，同时管理员可以在线回收权限。

#### 概要设计

数据库运维平台使用申请单的方式进行权限申请，普通用户如需申请权限，需要提交对应的申请流程单。因为每种业务类型下业务数据不同，所以提交申请单前需要填写的申请数据不同。普通用户提交申请单后系统根据申请单模板生成审批流程节点，等待所有审批节点审批通过后更新用户权限表，同时管理员可以回收权限。

#### 详细设计

###### 权限申请

申请权限类别：

- 库权限申请
- 表权限申请
- 表字段权限申请

为了详细说明权限申请对接申请单处理流程，**列举库权限申请的全流程处理过程：**

步骤一：设计库权限申请的表结构和申请界面

处理流程：用户点击【库权限申请】按钮 -> 填写申请参数信息 -> 点击【提交申请】按钮。

<img src=".\images\image-20220119163153744.png" alt="image-20220119163153744" style="zoom:60%;"/>

dms_s_apply_database：库权限申请表

| 字段名            | 数据类型     | 主键 | 非空 | 注释                                    |
| ----------------- | ------------ | ---- | ---- | --------------------------------------- |
| id                | varchar(64)  | √    | √    | 库权限申请表主键，取UUID                |
| user_code         | varchar(64)  |      | √    | 申请用户编码                            |
| apply_order_id    | varchar(64)  |      | √    | 申请单ID                                |
| apply_instance_id | varchar(64)  |      | √    | 申请操作的实例ID                        |
| apply_database    | text         |      | √    | 申请操作的库名称，多个库以逗号分隔      |
| apply_validity    | tinyint      |      | √    | 申请权限的有效期，单位：月，-1 表示永久 |
| apply_behavior    | varchar(128) |      | √    | 申请权限行为 eg: SELECT,UPDATE          |
| apply_reason      | text         |      |      | 申请原因                                |



步骤二：根据申请单流程模板计算生成审核流程步骤

处理流程：从字典信息中获取业务功能类型编码 -> 根据申请单用户编码、开发团队、业务类型编码、业务参数信息调用【生成申请单接口】。

字典定义：

> 业务类型字典定义：
>
> 字典类别：DMS_BUSINESS_FUNCTION_TYPE
>
> 类别名称：数据库管理平台业务功能类型
>
> 字典明细：
>
> - 数据值：APPLY_DATABASE
> - 显示值：库权限申请类型

 生成申请单接口定义：

> 入参：申请用户编码，申请单用户开发团队，业务类型编码，业务类型参数JSON
>
> 返回值：生成的申请单ID
>
> 描述：该方法多次 INSERT 数据，数据之间存在逻辑关系， 需要保证方法操作的原子性，所以使用Spring 的 @Transaction 注解注释该方法
>
> 处理流程：
>
> - 根据业务类型和业务类型参数JSON数据构建业务数据对象；
> - 根据业务类型获取绑定的申请单流程模板，如果没有绑定则取默认的流程模板；
> - 根据申请单流程模板和申请单用户编码计算生成审批节点数据；
> - 根据申请用户编码，开发团队，流程模板信息，构建保存申请单对象并且返回申请单主键；
> - 根据申请单信息和审批节点数据构建保存申请单审核流程数据；
> - 根据申请单信息、业务数据对象、申请用户编码信息构建保存库权限申请表数据；
> - 返回生成的申请单主键；



步骤三：审核通过后将申请数据写入到用户申请权限表

处理流程：因为没有绑定自定义流程模板，所以使用默认流程模板。管理员审批申请单 -> 系统调用申请单结束后置处理动作。

管理员在界面点击审批同意按钮，后台根据审批同意、业务类型编码调用后台服务，后台根据业务类型生成数据库权限申请单实现类，然后调用实现类的 audit 方法。

用户申请权限缓存设计

> Redis使用HASH数据结构存储
>
> Key ：DMS_USER_APPLY_AUTH
>
> Field：用户编码_申请权限类别
>
> Value：申请的元素
>
> DMS_USER_APPLY_AUTH:{
>
> ​	// USERCODE_申请权限类别：申请的元素
>
> }

根据不同的业务功能类型设计不同的功能申请单类

> 抽象统一的业务申请单抽象类口，定义申请单的所有动作，不同的申请单类型实现具体的操作方法
>
> public abstract class AbstractBusinessApply {
>
> ​    // 审核通过后的处理流程
>
> ​    void afterApproved();
>
> ​    // 审核拒绝之后的处理流程
>
> ​    void afterReject();
>
> ​	// 审批
>
> ​	void audit(Boolean isApproved);
>
> ​	// 取消
>
> ​	void cancel();
>
> ​	/** 生成申请单接口
>
> ​	* 入参：申请用户编码，申请单用户开发团队，业务类型编码，业务类型参数JSON
>
> ​	**/	
>
> ​	@Transaction 
>
> ​	public final String generateApplyOrder(String applyUserCode, String accCode, String businessType,  String  businessJsonStr) {
>
> ​		// 根据业务类型和业务类型参数JSON数据构建业务数据对象；
>
> ​		// 根据业务类型获取绑定的申请单流程模板，如果没有绑定则取默认的流程模板；
>
> ​		// 根据申请单流程模板和申请单用户编码计算生成审批节点数据；
>
> ​		// 根据申请用户编码，开发团队，流程模板信息，构建保存申请单对象并且返回申请单主键；
>
> ​		// 根据申请单信息和审批节点数据构建保存申请单审核流程数据；
>
> ​		// 根据申请单信息、业务数据对象、申请用户编码信息构建保存库权限申请表数据；
>
> ​		// 返回生成的申请单主键；
>
> ​	} 
>
> }
>
> 设计库权限申请流程单实现类
>
> public class DatabaseBusinessApplyImpl extends BusinessApply {
>
> ​	// 库权限申请对象
>
> ​	private ApplyDatabaseDO applyDatabaseDO; 
>
> ​	// 申请权限用户编码
>
> ​	private String applyUserCode;
>
> 
>
> ​    poublic void afterApproved() {
>
> ​    	// 处理流程
>
> ​		// 1. 根据库权限数据对象、申请权限用户编码构建申请权限表数据
>
> ​		// 2. 更新申请单状态为已通过
>
> ​		// 3. 保存申请权限表数据
>
> ​		// 4. 删除 userCode 对应的用户库权限申请权限缓存数据
>
> ​    }
>
> ​	public void afterReject() {
>
> ​		// 处理流程
>
> ​		// 1. 更新申请单状态为拒绝
>
> ​	}
>
> ​	public void audit (Boolean isApproved) {
>
> ​		// 处理流程
>
> ​		// 根据库权限申请对象获取申请单流程信息申请单信息
>
> ​		// 根据当前流程步骤数和流程单审核节点数对比，判断流程单是否完成
>
> ​		//  更新当前申请单处理流程节点状态
>
> ​		//  如果流程单已经完成，同时最后审批同意那么进入申请单审核通过后置处理流程
>
> ​				// this.afterApproved()
>
> ​		//  如果 isApproved 为 false【审核拒绝】，则调用 afterReject方法
>
> ​				// this.afterReject()
>
>  	}
>
> ​	public void cancel() {
>
> ​		// 处理流程
>
> ​		// 更新申请单审核流程表数据
>
> ​		// 更新申请单信息表数据
>
> ​	}
>
> }

###### 权限回收

管理员可以回收普通用户申请的权限。普通用户提交申请单申请执行权限，当申请单被审核通过后，通过申请单详情计算权限详细信息，并且将其保存到用户申请权限表中。权限回收就是将其用户对应的申请权限表数据置为无效，同时清理缓存数据。

##### 界面原型

管理员回收普通用户权限页面

![image-20220119151907284](.\images\image-20220119151907284.png)

##### 数据库设计

dms_s_apply_authority：申请权限表

| 字段名               | 数据类型     | 主键 | 非空 | 注释                                                         |
| -------------------- | ------------ | ---- | ---- | ------------------------------------------------------------ |
| id                   | varchar(64)  | √    | √    | 申请权限表主键，取UUID                                       |
| user_code            | varchar(64)  |      | √    | 申请用户编码                                                 |
| apply_authority_type | char(1)      |      | √    | 申请权限类别：0 数据库、1 数据表、2 表字段                   |
| apply_order_id       | varchar(64)  |      | √    | 申请单ID                                                     |
| apply_behavior       | varchar(128) |      |      | 申请的行为 eg: SELECT,UPDATE                                 |
| apply_element        | text         |      |      | 申请的元素，每种申请权限类别的元素不同，多个元素时以逗号分隔，eg:  实例ID:库名称:表名称 bed3b402daf74:dbadmin:tableA |
| apply_begin_time     | datetime     |      | √    | 申请开始时间                                                 |
| apply_end_time       | datetime     |      | √    | 申请结束时间                                                 |
| valid_flag           | char(1)      |      | √    | 有效标志，0 无效，1 有效                                     |
| create_time          | datetime     |      | √    | 创建时间                                                     |
| update_time          | datetime     |      | √    | 更新时间                                                     |