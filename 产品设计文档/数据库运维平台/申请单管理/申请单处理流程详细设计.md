[toc]

## 集中申请单管控模块设计

### 需求分析

在新版本的数据库运维平台需要增加数据导入、导出、定时任务执行、SQL执行审计等操作，这些操作都存在需要二次确认的需求；

为了统一对数据库运维平台上面的申请单进行统一处理，设计一个公共的申请单模版，对申请单共性的地方进行统一管理。

### 详细设计

简易的申请单模块，大致分为申请单模版流程定义、申请单模版流程节点定义、申请单模版绑定业务模块、申请单查询、申请单审批等操作

**申请单模版定义**

模版定义有两大块内容，申请单流程模版基本信息与流程模块节点信息；

流程模版节点信息也就是对应每一个流程步骤上面的审批人员对象，节点信息是属于共用对象，节点信息一单维护好了就可以共用其他的申请流程模版中；

> 比如：
>
> 定义流程节点 node1-A用户、node2-B用户、node3-C用户
>
> 维护申请单模版template1，可以绑定node2-B用户、node1-A用户，流程就是2个节点
>
> 维护申请单模版template2，可以绑定node2-B用户、node1-A用户、node3-C用户，流程就是3个节点



数据库运维平台申请单定义最终的需求是满足不同业务模版的不同审批流程，通过申请单模版绑定业务模块来实现，但是相同的业务模块只能绑定一个申请单模版流程。

> 比如：按照之前的案例说明
>
> 维护申请单模版template1，可以绑定 数据集导出业务模块，那么用户在进行数据集导出的时候，就需要走模版template1的流程处理，2个节点审批(实际已流程处理机制为准)
>
> 维护申请单模版template2，可以绑定 SQL执行审计流程，那么用户在进行数据集导出的时候，就需要走模版template2的流程处理，3个节点审批(实际已流程处理机制为准)



**租户隔离**

上诉说明了申请单流程的定义与业务模块的关联，在实际使用场景说还有一个重要的因素，那就是每一个项目审批节点是不一样的，也就是审批的用户对象；

这一块内容那就得要管理用户来每次定义，同时为了不同租户使用不同的流程，这里就引入开发团队的机制来进行处理。

申请单流程模版与流程模块节点都有开发团队关联，系统管理员是不需要做流程的，所以没有开发团队也没有关系。



**申请单操作日志记录**

方便每一个申请单都有个性化信息记录，增加一个流程的操作日志，记录每一步的处理信息反馈，包含申请单生成记录、审批人审核记录、业务流程处理日志记录等。



**业务模版对接申请单需要怎么处理？**

+ 对接申请单

  业务模块在新增处理的时候，系统根据当前用户所属开发团队以及当前业务模块获取绑定的申请单模块流程，系统根据定义好的申请模块流程生成处理节点流程

+ 业务模块设计业务参数表

  申请单不保留任何与业务模块相关联的信息，所有的业务参数信息都自己保存，同时保存对接申请单之后反馈的申请单ID

+ 业务模块设计新增业务的界面

  业务模块的处理界面都是自己独立的，比如：数据集导出、sql执行审计，每一块的业务处理发起都是不同的界面，也都是通过不同的菜单处理的；只有新增处理之后才统一到申请单管理界面来查询。

+ 业务模块设计申请单业务详情界面

  这里可能会有疑惑，不是说统一在申请单管理界面查询吗，为什么又要设计详情界面了；

  其实申请单详细就是需要展示不同的业务模块内容，只是审核流程同意、拒绝一小部分界面可以共用。比如：数据集导出，那么得显示文件下载，数据集导出的文件信息等



**申请单审批流程案例**

案例一：系统默认流程，系统管理员审批，普通用户/开发团队用户申请

注：这一块的流程都需要到系统管理员进行审批才能进行完成

> <img src=".\images\image-20220114162121080.png" alt="image-20220114162121080" style="zoom:80%;" />

---

案例二：系统默认流程，系统管理员审批，系统管理员申请

注：系统管理的申请单默认系统都统一自动审批完成

> <img src=".\images\image-20220114162154142.png" alt="image-20220114162154142" style="zoom:80%;" />

---

案例三：用户自定义申请单流程模版，非流程节点的用户申请

注：当前业务模块绑定了此流程，同时申请的用户不在这个流程节点上面，那么申请单就需要重头来走这个流程

> ![image-20220114162236923](.\images\image-20220114162236923.png)

---

案例四：用户自定义申请单流程模版，流程某一个节点的用户申请

注：当前业务模块绑定了此流程，同时申请的用户在这个流程节点上面，那么申请单只需要从当前节点之后走这个流程，判断如果是最后一个节点，显示系统自动审核通过

> ![image-20220117140229086](.\images\image-20220117140229086.png)

### 界面设计原型

申请单模板管理首页原型：

![image-20220117165114308](.\images\image-20220117165114308.png)

申请单模板关联业务模块原型：

<img src=".\images\image-20220117142400764.png" alt="image-20220117142400764" style="zoom:50%;" />

添加申请单模板原型：

<img src=".\images\image-20220117163419765.png" alt="image-20220117163419765" style="zoom:80%;" />

申请单模板节点管理首页原型图：

<img src=".\images\image-20220117164547054.png" alt="image-20220117164547054" style="zoom:80%;" />

添加模板节点原型图

<img src=".\images\image-20220117164804536.png" alt="image-20220117164804536" style="zoom:60%;" />

 申请单信息管理首页原型图：

<img src=".\images\image-20220113172246114.png" alt="image-20220113172246114" style="zoom:80%;" />

**业务模块对接案例 - 界面**

申请单详情信息原型图：

<img src=".\images\image-20220113172516743.png" alt="image-20220113172516743" style="zoom:80%;" />

提交申请单原型图：

![image-20220114222250683](.\images\image-20220114222250683.png)

申请单操作日志原型图：

![image-20220113173620591](.\images\image-20220113173620591.png)

### 数据库表结构设计

dms_s_apply_template：申请单模板表

| 字段名           | 数据类型      | 主键 | 非空 | 注释                                                         |
| ---------------- | ------------- | ---- | ---- | ------------------------------------------------------------ |
| id               | varchar(64)   | √    | √    | 申请单模板表主键，取UUID                                     |
| template_name    | varchar(64)   |      | √    | 申请单模板名称                                               |
| template_type    | char(1)       |      | √    | 模板类别，0 系统、1 自定义，系统类型不允许编辑               |
| acc_code         | varchar(64)   |      |      | 所属开发团队编码，支持开发团队隔离，系统默认为空             |
| template_node_id | varchar(2048) |      | √    | 模板节点ID，以逗号分隔并且是有序的                           |
| business_type    | text          |      |      | 绑定生效业务模块编码，多个业务模块以逗号分隔,通过字典定义，比如：权限申请、结果集导出等 |
| remark           | text          |      |      | 备注说明                                                     |
| create_time      | datetime      |      | √    | 创建时间                                                     |
| update_time      | datetime      |      | √    | 更新时间                                                     |

dms_s_apply_template_process_node：申请单模版流程节点表

| 字段名             | 数据类型    | 主键 | 非空 | 注释                                                 |
| ------------------ | ----------- | ---- | ---- | ---------------------------------------------------- |
| id                 | varchar(64) | √    | √    | 申请单模版流程节点表主键，取UUID                     |
| template_node_type | char(1)     |      | √    | 模板节点类别，0 系统、1 自定义，系统的类型不允许编辑 |
| template_node_name | varchar(64) |      | √    | 申请单模板节点名称                                   |
| audit_object       | text        |      | √    | 审核用户编码/审核用户组编码，多个编码时以逗号分隔    |
| audit_object_type  | char(1)     |      | √    | 审核对象类别，0 用户、1 用户组                       |
| user_code          | varchar(64) |      |      | 创建者编码，系统创建时为空                           |
| acc_code           | varchar(64) |      |      | 开发团队编码，系统创建时为空                         |
| remark             | text        |      |      | 节点备注                                             |
| create_time        | datetime    |      | √    | 创建时间                                             |
| update_time        | datetime    |      | √    | 更新时间                                             |

dms_s_apply_order：申请单信息表

| 字段名            | 数据类型     | 主键 | 非空 | 注释                                                         |
| ----------------- | ------------ | ---- | ---- | ------------------------------------------------------------ |
| id                | varchar(64)  | √    | √    | 申请单主键，取UUID                                           |
| apply_template_id | varchar(64)  |      | √    | 申请单使用的流程模板ID                                       |
| business_type     | varchar(125) |      | √    | 申请单类别，属于业务类型，通过字典定义，比如：权限申请、结果集导出等 |
| apply_status      | char(1)      |      | √    | 申请单整体状态，1正在发起流程、2 审核中、3 已撤销、4 已驳回、5 流程已完成，业务处理中、6已完成 |
| user_code         | varchar(64)  |      | √    | 创建用户编码                                                 |
| acc_code          | varchar(64)  |      |      | 开发团队编码，管理员申请的申请单为kong                       |
| remark            | text         |      |      | 备注信息                                                     |
| create_time       | datetime     |      | √    | 创建时间                                                     |
| update_time       | datetime     |      | √    | 更新时间                                                     |

dms_s_apply_order_process：申请单审核流程表

| 字段名            | 数据类型         | 主键 | 非空 | 注释                                                         |
| ----------------- | ---------------- | ---- | ---- | ------------------------------------------------------------ |
| id                | varchar(64)      | √    | √    | 申请单审核流程表主键，取UUID                                 |
| apply_order_id    | varchar(64)      |      | √    | 申请单ID                                                     |
| apply_step        | tinyint unsigned |      | √    | 流程步骤                                                     |
| audit_status      | char(1)          |      | √    | 审核状态，1 等待处理、2、正在审核中、3 系统自动审核同意、4 审核同意、5 审核驳回 |
| audit_object_type | char(1)          |      | √    | 可审核对象类型，0 用户、1 用户组                             |
| audit_object      | text             |      | √    | 可审核对象，用户或者用户组编码                               |
| audit_msg         | text             |      |      | 审核意见                                                     |
| audit_user_code   | varchar(64)      |      | √    | 审核用户编码                                                 |
| create_time       | datetime         |      | √    | 创建时间                                                     |
| update_time       | datetime         |      | √    | 更新时间                                                     |

dms_s_apply_order_log：申请单操作日志表

| 字段名              | 数据类型    | 主键 | 非空 | 注释                         |
| ------------------- | ----------- | ---- | ---- | ---------------------------- |
| id                  | varchar(64) | √    | √    | 申请单操作日志表主键，取UUID |
| apply_order_id      | varchar(64) |      | √    | 申请单id                     |
| operation_user_code | varchar(64) |      | √    | 操作用户编码                 |
| operation_details   | text        |      | √    | 操作详情                     |
| operation_time      | datetime    |      | √    | 操作时间                     |









### 历史设计

数据库运维管理平台中对各用户和用户组进行了严格的权限控制，对于没有相关权限的用户执行诸如数据导出、数据导入这些对系统安全运维有重要

影响的操作均需要提交申请单，审批通过后才能操作。申请单是根据绑定的审批流程模板生成的，审批流程模板由管理员定义维护，审批流程模板由多个审批节点组成。

**功能点设计**

- 申请单模板管理
- 申请单模板节点管理
- 申请流程绑定申请单模板
- 发起申请
- 申请单流程审批
- 申请单信息查询
- 查询申请单操作日志

**名词解析**

- 申请单状态 - 【审核中】：所有申请单的初始状态；
- 申请单状态 - 【已取消】：申请单的关闭状态；
- 申请单状态 - 【已驳回】：当申请单的最后一个处理流程状态为拒绝时申请单的状态为已驳回；
- 申请单状态 - 【已通过】：当申请单的所有处理流程都被同意时申请单的状态为已通过；
- 审核状态 - 【待处理】：申请单的审核节点未处理；
- 审核状态 - 【自动同意】：申请用户属于当前申请单的审核节点的审批人时，或者申请用户属于当前申请单的审核节点的所属用户组时。同时审核节点必须满足一个条件：是首节点或者非首节点时前一个审批节点已同意。
- 审核状态 - 【审核同意】：申请单的审核节点同意；
- 审核状态 - 【拒绝】：申请单的审核节点拒绝；

**详细设计**

**核心流程设计**

租户隔离

申请单模块信息基于开发团队进行隔离，不同开发团队之间互不影响，如：A开发团队定义的模板信息无法被B开发团队使用。

申请单流程模板定义与审批流程绑定

申请单流程模板由申请单模板节点 

组成，定义模板前需要先定义好节点信息。模板节点定义了审批人维度和审批人信息，审批人维度包含用户、用户组，审批人信息与之对应的是用户编码、用户组编码。业务模块需要绑定申请单模板，每个开发团队中，一个业务模块只能绑定一个申请单流程模板，如果没有绑定则使用默认的模板。

申请单模板使用左右结构形式关联业务模块，未关联的业务模块显示在左边，已关联的显示在右边，业务模块通过字典定义维护。如：数据导出:SQL结果集导出、数据导出:数据库导出、SQL执行申请 等业务模块。

 申请单信息如何展示个性化业务信息

申请单通过 `apply_type`  字段【申请单类别】区别不同的业务类别，如：数据导出、SQL执行申请。同时每种业务类别设计单独的表结构，用于存储业务参数信息。前端界面也根据不同的业务类型设计不同的界面。

步骤一：根据特定的业务场景设计表结构和界面

不同的业务场景拥有不同的业务数据和界面布局，根据不同的业务场景的申请单设计特定的表结构和界面，界面包含申请单的基本信息、申请单业务参数信息、申请单审核通过后的处理信息。

步骤二：根据绑定的申请单流程模板计算审核流程步骤

根据绑定的申请单流程模板计算生成审核流程节点数，同时系统计算生成审核详情记录。如果业务场景未绑定申请单流程模板则使用默认流程模板。

步骤三：审核通过根据业务类型做相应处理

申请单流程审核通过后根据特定的业务场景和业务场景数据调用相应的流程结果处理方法。例如：数据导出申请单，当数据导出流程审核通过后，进行数据导出。

申请单操作日志记录

系统记录申请单各各流程的操作日志，包含申请单生成记录、审批人审核记录、业务流程处理日志记录。	