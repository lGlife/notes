## 新员工培训业务场景

### 业务需求

模拟书店购买书籍的业务流程

**基础信息：**

1、书籍类型维护，区分类型，科学、历史、文物、天文、童话、神话、小说哲学、法律、军事、宗教、经济、历史、地理、农业科学、工业技术、交通运输、航空等等

2、书籍的信息维护，书籍名称、书籍出版社、书籍类型等

3、书籍的库存维护，入库的书籍类型、数量等

**折扣信息：**

折扣券分为：满减券、立减券（本次不包含）、折扣券

折扣券：

* 订单满100元，9.5 折
* 订单中工业技术类型书籍满 100元，工业技术类型书籍打 8 折
* 订单中地理类型书籍满200元，地理类型书籍打 9 折
* 订单满300元，单次订单打7折，不与其他折扣叠加使用满减券

满减券

* 订单满200元（原价计算），在原有优惠基础之上再优惠40元
* 订单满500元（原价计算），在原有优惠基础之上再优惠100元，不与其他折扣叠加
* 订单满1000元（原价计算），在原有优惠基础之上再优惠200元

**业务流程：**

1、办理书籍入库

2、书籍上架流程，普通销售员工进行书籍上架销售申请，商品的上架流程推送给销售部门主管，审核之后才能进行上架销售；

>  书籍有库存才能发起上架申请，上架通过之后系统默认生成当前书籍的销售信息，书籍的销售信息可以单独修改，但是修改上架的销售数量不允许超过仓库数量的80%；
>
> 这里不做员工信息模块，到时候只需要一个界面可以申请上架流程，另外一个界面审批上架流程即可

3、购买书籍；流程：购买书籍信息维护 -> 试算 -> 试算时需要给客户推算出最优的购买方案 -> 结算

4、报表信息查询，每日、每周、每月，书籍的销售数量排行、销售金额排行，

**成交金额如何算？**

满100打9.5折，这个打折完之后，单本成交金额怎么算？ 比如买了A(50元)和B(20)和C(10元)、D(10元)、E(10元)的三本书籍，总95块钱，那A的成交金额是49元，B的成交金额时9元；要是用了满减券，满了200减40了呢？那就减掉的40平均减到每本书

#### 适配层组件使用场景需求

**微服务框架**

根据需求目前初步划分三个微服务模块：基础数据服务、报表中心、订单中心

**分布式消息队列**

普通销售员工进行书籍上架流程申请，销售部门主管查询到有书籍上架的审批流程，进行审批，审批之后才能进行上架销售。

**分布式缓存**

1、将每次销售的书籍信息，写入缓存，比如：当日实时消息金额、当日实时消息书籍数量、每小时消息金额等等监控数据

2、可以将折扣规则写入缓存，对于真实商品的试算、结算场景，并发量是非常高的，这一块我们就考虑将缓存用起来；这里将折扣规则提前写入缓存，避免在试算、结算过程中再去查询数据库，提供处理效率。

> 存储到缓存如何存储，存储是什么结构，都是有讲究的；要结合业务场景，尽量能精准命中缓存key值

**分布式非结构化存储**

书籍的信息需要上传书籍的封面或者书籍目录等信息，图片存储到非结构化存储中；支持在线浏览。

**分布式定时任务**

定时任务采集每小时每天的销售数据，写入数据库，提供给之后的销售报表查询功能使用

**服务网关**

提供给外部查询销售的监控数据，提供：查询每日的消息金额接口、每月的销售数据（书籍的销售情况，按照销售金额排名）；注册到服务网关，提供免鉴权、需要鉴权两种模式；需求鉴权的模式，自己写测试类进行调用测试。

**分布式数据库**

报表中心监控数据表、订单中心的商品订单数据表都采取水平表设计，也就是分库分表设计



#### 数据库设计

书籍类型表

```sql
CREATE TABLE `book_type` (
  `book_type_uuid` varchar(64) NOT NULL COMMENT '书籍类型UUID',
  `book_type_code` varchar(128) NOT NULL COMMENT '书籍类型编码',
  `book_type_name` varchar(512) NOT NULL COMMENT '书籍类型名称',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP  COMMENT '类型创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '类型更新时间',
  PRIMARY KEY (`book_type_uuid`),
  UNIQUE KEY `idx_book_type_code` (`book_type_code`)
) COMMENT='书籍类型表'
```

书籍信息表

```sql
CREATE TABLE `book_info` (
  `book_uuid` varchar(64) NOT NULL COMMENT '书籍信息UUID',
  `book_type_uuid` varchar(64) NOT NULL COMMENT '关联书籍类型UUID',
  `book_code` varchar(64) NOT NULL COMMENT '图书编码',
  `book_name` varchar(512) NOT NULL COMMENT '图书名称',
  `book_img_addr` varchar(2048) NULL DEFAULT '' COMMENT '书籍图片url地址',
  `author` varchar(64) NOT NULL COMMENT '作者',
  `press` varchar(128) NULL COMMENT '出版社',
  `profiles` text NULL DEFAULT ''  COMMENT '图书简介',
  `publishing_time` datetime NOT NULL COMMENT '出版时间',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP  COMMENT '书籍信息创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '书籍信息更新时间',
  PRIMARY KEY (`book_uuid`),
  UNIQUE KEY `idx_book_code` (`book_code`)
) COMMENT='书籍信息表'
```

库存表

```sql
CREATE TABLE `book_inventory` (
  `inventory_uuid` varchar(64) NOT NULL COMMENT '库存UUID',
  `book_uuid` varchar(64) NOT NULL COMMENT '书籍信息UUID',
  `inventory_quantity` int(8) NOT NULL DEFAULT 0  COMMENT '库存总数，累加',
  `inventory_remaining` int(8) NOT NULL DEFAULT 0  COMMENT '库存剩余数',
  `inventory_quantity_update_time` datetime  NULL  COMMENT '库存数更新时间',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '库存信息创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '库存信息更新时间',
  PRIMARY KEY (`inventory_uuid`)
) COMMENT='书籍库存表'
```

入库批次表

```sql
CREATE TABLE `inventory_batch` (
  `inventory_batch_uuid` varchar(64) NOT NULL COMMENT '入库批次UUID',
  `book_uuid` varchar(64) NOT NULL COMMENT '书籍信息UUID',
  `quantity` int(8) NOT NULL DEFAULT 0  COMMENT '入库数量',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP  COMMENT '批次信息创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP  COMMENT '批次信息更新时间',
  PRIMARY KEY (`inventory_batch_uuid`)
) COMMENT='入库批次表'
```

折扣规则表

```sql
CREATE TABLE `discount_rules` (
  `discount_rules_uuid` varchar(64) NOT NULL COMMENT '折扣规则UUID',
  `discount_type` char(2) NOT NULL COMMENT '折扣类型：1、满减券、2、立减券(本次不包含)、3、折扣券',
  `allow_overlay_flag` char(2) NOT NULL  COMMENT '是否允许叠加使用, 0:不允许，1：允许',
  `use_category` varchar(128) NOT NULL  COMMENT '使用品类，这里为书籍类型，* 表示所有类型均可使用',
  `indexes` float NOT  NULL  COMMENT '指标值，当订单总金额达到这个值时，可以享受优惠，单位：元',
  `preferential_value` float NOT NULL  COMMENT '优惠值，（折扣券，这里就是百分比；其他类型就是实际金额，单位：元）',
  `valid_start_time` datetime NOT NULL COMMENT '有效期，开始时间',
  `valid_end_time` datetime NOT NULL COMMENT '有效期，截止时间',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP  COMMENT '折扣规则信息创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '折扣规则信息更新时间',
  PRIMARY KEY (`discount_rules_uuid`)
) COMMENT='折扣规则表'
```

上架审批流程表

```sql
CREATE TABLE `shelves_approval_process` (
  `approval_process_uuid` varchar(64) NOT NULL COMMENT '审批流程UUID',
  `book_uuid` varchar(64) NOT NULL COMMENT '书籍信息UUID',
  `quantity` int(8) NOT NULL DEFAULT 0  COMMENT '上架总数量',
  `unit_price` float NOT NULL  COMMENT '上架单价',
  `initiate_approval_time` datetime NOT NULL COMMENT '流程发起时间',
  `end_approval_time` datetime NULL COMMENT '审批时间',
  `approval_type` char(2) NOT NULL COMMENT '审批状态，0：审批不通过，驳回；1：审批通过；2：待审批',
  `approval_description` text NULL COMMENT '审批说明',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP  COMMENT '审批流程信息创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '审批流程信息更新时间',
  PRIMARY KEY (`approval_process_uuid`)
) COMMENT='上架审批流程表'
```

书籍商品表

```sql
CREATE TABLE `book_commodity` (
  `book_commodity_uuid` varchar(64) NOT NULL COMMENT '书籍商品信息UUID',
  `book_uuid` varchar(64) NOT NULL COMMENT '书籍信息UUID',
  `commodity_price` float NOT NULL COMMENT '商品单价',
  `quantity` int(8) NOT NULL DEFAULT 0  COMMENT '上架总数量',
  `shelves_remaining_quantity` int(8) NOT NULL  COMMENT '上架剩余数量',
  `is_valid` char(2) NOT NULL  COMMENT '是否有效，0：无效，表示已下架，不可出售，设置无效上架剩余数量清空补回库存；1：有效，未下架可出售',
  `description` text NULL  COMMENT '商品信息说明，默认填充 书籍的简介信息（图书简介）',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP  COMMENT '书籍商品信息创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '书籍商品信息更新时间',
  PRIMARY KEY (`book_commodity_uuid`)
) COMMENT='书籍商品表'
```

订单表

```sql
CREATE TABLE `order` (
  `order_uuid` varchar(64) NOT NULL COMMENT '订单UUID',
  `total_order_amount` float NOT NULL COMMENT '订单总金额',
  `order_time` datetime NOT NULL COMMENT '下单时间',
  `order_status` char(2) NOT NULL  COMMENT '订单状态，0：交易失败；1：交易成功；2：交易结束',
  `description` text NULL  COMMENT '订单备注',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '订单信息创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP  COMMENT '订单信息更新时间',
  PRIMARY KEY (`order_uuid`)
) COMMENT='订单表'
```

订单明细表

```sql
CREATE TABLE `order_details` (
  `order_details_uuid` varchar(64) NOT NULL COMMENT '订单明细UUID',
  `order_uuid` varchar(64) NOT NULL COMMENT '订单UUID',
  `book_commodity_uuid` varchar(64) NOT NULL COMMENT '商品UUID',
  `commodity_quantity` int(8) NOT NULL COMMENT '商品数量',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '订单明细信息创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '订单明细信息更新时间',
  PRIMARY KEY (`order_details_uuid`)
) COMMENT='订单明细表'
```

书籍销售监控表

```sql
CREATE TABLE `book_sales_monitor` (
  `book_sales_uuid` varchar(64) NOT NULL COMMENT '图书销售UUID',
  `book_uuid` varchar(64) NOT NULL COMMENT '出售的书籍的UUID',
  `book_type_uuid` varchar(64) NOT NULL COMMENT '出售的书籍的类型UUID',
  `deal_amount` float NOT NULL COMMENT '每小时的成交额',
   sale_count int not NULL COMMENT '每小时的销售数量',
  `statistical_time` dastetime NOT NULL COMMENT '统计时间,yyyy-MM-dd HH',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '销售监控信息创建时间',
  PRIMARY KEY (`book_sales_uuid`)
) COMMENT='书籍销售监控表'
```