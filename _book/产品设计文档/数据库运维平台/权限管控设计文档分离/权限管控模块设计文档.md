[toc]

### 权限管控模块设计文档

#### 概要设计

##### 实例、数据库权限

实例、数据库的权限操作，这一块按照白名单的权限设计考虑，由管理员定义用户、用户组允许操作的实例、数据库的权限。

##### 表、字段权限

表、字段的权限操作，这一块按照黑名单的权限设计考虑；

只要用户有库的权限，那么库下属的表、字段都自动赋予了对应的权限；为了满足可控的需求，管理员可以定义限制表、字段的执行规则进行拦截处理，规则支持定义不同执行类型和指定表、字段元素。

##### 全局限制规则

为了满足生产环境中，管理员对某一类运维人员统一只开放SELECT操作的权限的需求，我们可以定义**全局限制规则**，限制SELECT以外的所有权限。全局限制规则是一个全局的权限规则，无需和实例绑定。

##### 用户针对限制操作的申请权限

同时对于没有权限操作的用户，可以自行进行申请操作，申请包含时效性，管理员也可以随时进行缩短时效以及回收权限操作。申请权限的优先级高于限制权限。

##### 审计行为 - SQL需要密钥执行

审计行为由管理员定义，支持定义对库、表的不同执行类型进行执行拦截，执行用户需要对当前需要执行的sql进行执行申请，申请通过后平台会自动生成一个执行秘钥，申请用户可以通过输入秘钥执行SQL，也可以在申请单中直接执行SQL语句。审计行为的优先级最高。

#### 详细设计 

###### 访问权限绑定/解绑：

绑定/解绑界面以左右结构布局，左边布局显示用户/用户组信息，右边布局显示权限信息，权限信息包含访问数据库授权和限制规则绑定。管理员勾选需要绑定的用户/用户组和相应的权限信息，最后点击保存即可。如需解除绑定可以再次点击已勾选信息，再次点击保存。

绑定/解绑时根据权限维度编码做判断，如果编码存在那么就更新权限绑定数据，不存在则保存数据。以【实例ID:库名称】的形式保存允许访问的库数据，多个库信息以逗号分隔，如：`34jffds3432:pcloud_admin,32431fdsafd:hot_db`

###### 限制规则定义：

限制规则分为：数据表、表字段、全局限制权限、审计行为。限制规则需要指定限制行为，限制行为分为：SELECT、UPDATE、DELETE、INSERT、CREATE、DROP、ALTER、ALL。全局限制权限无需指定限制元素，数据表、表字段、申请行为需要制定限制元素。限制规则类别不同所指定的限制元素不同，数据表和审计行为的指定元素需要指定到表，而表字段权限的指定元素需要制定到字段。指定到表的限制元素数据格式为：【实例元素:库元素:表元素】，指定到字段的限制元素数据格式为：【实例元素:库元素:表元素:字段元素】，

实例元素、库元素、表元素、字段元素的模糊匹配表达式只支持 * 字符，如表元素：【\*table\*】 将匹配 tableA、tableAA、Btable、BtableB等表，【\*table\*hello\*】 将匹配 sss`table`sss`hello`sss表名，如果只有一个 * 字符则表示全部表。逻辑底层实现基于正则表达式，将 \* 字符替换为 .\* 字符，然后使用 ```Pattern.matches(String regex, CharSequence input)```方法进行匹配。

###### 限制权限绑定/解绑：

限制权限的绑定和解绑形式同访问权限的绑定和解绑相同，都是以左右布局格式展示。唯一不同的是在后端数据保存时保存的是限制规则记录ID，多条限制规则元素时以逗号分隔。

###### 查询用户/用户组权限绑定关系

通过查询 `权限绑定表 ` 获取用户/用户组的权限绑定数据和当前获取的数据源数据渲染绑定界面。

###### 融入权限体系之后的相关改动：

- 查询表数据改动，如果当前用户绑定了限制表权限，那么将会根据规则排除被限制的表，换言之，获取到的表名等于全部表名减去被限制的表名；

- SQL执行流程改动：

  - 审计权限拥有最高优先级，如果是审计执行的SQL语句，将无需执行其它限制行为拦截器。

  - 非审计执行的SQL语句，权限拦截器的执行流程为：全局限制权限拦截器 -> 表权限限制权限拦截器 -> 字段限制权限拦截器。在表权限拦截器中需要过滤掉申请的表权限，字段限制权限需要过滤掉申请的字段权限。同时在全局权限拦截器中也需要过根据申请的权限过滤掉特定的拦截权限。

  - 如果权限拦截器拦截了待执行的SQL语句，将中断SQL语句的执行并记录日志信息。

    <img src=".\images\image-20220120171049852.png" alt="image-20220120171049852" style="zoom:50%;" />
  
- 申请执行权限优先级大于限制执行权限，如果同时存在限制权限和与之相同的申请权限，那么该用户将有权限执行，例如：申请执行SQL语句，无论该用户是否拥有SQL语句中操作表的权限，只要申请被同意之后，该SQL语句就能够被执行。

##### 界面原型

限制规则查看页面

<img src=".\images\image-20211224145124243.png" alt="image-20211224145124243" style="zoom:60%;" />

添加数据表限制规则页面

![image-20211224145203761](.\images\image-20211224145203761.png)

添加表字段限制规则页面

![image-20211224145236014](.\images\image-20211224145236014.png)

添加全局限制规则页面

![image-20211224145259368](.\images\image-20211224145259368.png)

添加审计行为页面

![image-20211224145318538](.\images\image-20211224145318538.png)

管理员授权数据实例和库页面

![image-20211224145411472](.\images\image-20211224145411472.png)

管理员绑定限制规则页面

![image-20211224145428028](.\images\image-20211224145428028.png)

##### 数据库设计

dms_s_forbid_authority_rule：限制权限规则表

| 字段名          | 数据类型     | 主键 | 非空 | 注释                                                         |
| --------------- | ------------ | ---- | ---- | ------------------------------------------------------------ |
| id              | varchar(64)  | √    | √    | 限制权限规则表主键，取UUID                                   |
| rule_name       | varchar(128) |      | √    | 限制权限名称                                                 |
| authority_type  | char(1)      |      | √    | 权限类别：0 数据表、1 表字段、2 全局限制权限、3审计行为      |
| forbid_behavior | varchar(128) |      | √    | 限制行为 eg: SELECT,UPDATE                                   |
| forbid_element  | longtext     |      |      | 限制元素，每种限制权限类别的限制元素不同，多个元素时以逗号分隔，eg:  实例ID:库名称:表名称 bed3b402daf74:dbadmin:tableA |
| create_time     | datetime     |      | √    | 创建时间                                                     |
| update_time     | datetime     |      | √    | 更新时间                                                     |

dms_s_allow_database_rule：允许访问数据库规则表

| 字段名         | 数据类型     | 主键 | 非空 | 注释                                      |
| -------------- | ------------ | ---- | ---- | ----------------------------------------- |
| id             | varchar(64)  | √    | √    | 允许访问数据库规则表主键，取UUID          |
| allow_database | varchar(128) |      | √    | 允许访问的库，库以实例ID:库名称的形式保存 |

dms_s_authority_bind：权限绑定表

| 字段名                   | 数据类型     | 主键 | 非空 | 注释                                     |
| ------------------------ | ------------ | ---- | ---- | ---------------------------------------- |
| id                       | varchar(64)  | √    | √    | 权限绑定表主键，取UUID                   |
| authority_dimension      | char(1)      |      | √    | 权限维度：0 用户、1 用户组               |
| authority_dimension_code | varchar(128) |      | √    | 权限维度编码                             |
| forbid_authority_rule_id | text         |      |      | 限制权限规则主键，多个主键以逗号分隔     |
| allow_database_rule_id   | varchar(64)  |      |      | 允许访问的库规则主键，多个主键以逗号分隔 |
| create_time              | datetime     |      | √    | 创建时间                                 |
| update_time              | datetime     |      | √    | 更新时间                                 |
